# Cloud ID to Exfiltration attack
Cloud identity abuse, such as Password Spraying and MFA fatigue, is one of the techniques attackers employ to perpetrate further breaches. 
After successfully logging into Office, what are they going to do, and can we visualize these suspicious activities in Microsoft Defender XDR? 
This simulation is crucial for validating cloud-based identity attacks and detecting suspicious activities such as data collection, exfiltration, and their impact.

## Red Note (test insights)
This is for ***"Cloud base ID to Exfiltration attack"*** simulation steps. 

![image](https://github.com/LearningKijo/ResearchDev/assets/120234772/877a2307-ffaf-4c66-9551-797856efceb6)
> Simulation process flows and generated alerts in XDR portal

### Simulation Steps
***"Background: User A typically accesses Outlook from Japan. However, an attacker could potentially guess the email address and password, or they may have obtained them illegally from the black market. 
Consequently, the attacker repeatedly attempts to log in to Outlook. Thanks to MFA, the system prompts for verification, but the user repeatedly denies (experiencing MFA fatigue). 
Eventually, the authentication request is accepted."***

1. User A (Attacker) accessed Outlook through Tor browser from a non-Japanese IP address and ***intentionally attempted to log in incorrectly about 15 times within a 5-minute period***.

    - If MFA is enabled for the target account, persist in rejecting the login attempts. 
    - If MFA is not enabled, continue to enter the incorrect password. 

    After approximately 15 failed attempts, User A (Attacker) successfully logged into Outlook through Tor browser on the 16th try.

2. Create some forwarding rules and Enable forwarding in Outlook.
3. Access SharePoint site and open around 40 files.
5. Download around 40 files.
6. Delete around 40 files.

> [!Important]
> 1. Assuming that the target account already has access to Outlook from a legitimate IP address(country) before executing this testing.
> 2. Depending on the Access Control settings in your test environment, repeated failed login attempts might trigger Risk-based Conditional Access policies, potentially blocking access to Outlook for the target account. Please ensure that there is no adverse impact on the target account.
> 3. Installation of Tor Browser is required for testing purposes.
> 4. A forwarding account (for the attacker) is necessary during the creation of forwarding rules.
> 5. It is required to have a SharePoint site with more than 40 files, which should be dummy (not important files).

## Alerts & Detections
After simulating the aforementioned process flows, the resulting alerts were generated and correlated into a single incident in the Microsoft Defender XDR portal.

#### Microsoft Entra ID Protection
- [x] Anonymous IP address

#### Microsoft Defender for Cloud Apps
- [x] Activity from a Tor IP address
- [x] Logon from a risky IP address
- [x] Suspicious inbox forwarding rule
- [x] Investigation priority score increase
- [x] Multiple failed login attempts
- [x] Suspicious file access activity (by user)
- [x] Unusual file download (by user)
- [x] Unusual file deletion activity (by user)

#### Microsoft Defender XDR
- [x] Multiple Failed Sign-Ins
- [x] Suspicious behavior: Multiple failed login attempts
- [x] Suspicious behavior: Impossible travel activity
- [x] Suspicious massive data read

> [!Note]
> - At first, the alerts generated by the XDR portal may vary and not always be the same. 
> - Regarding access, download, and delete file activities ([Anomaly detection policies by MDA](https://learn.microsoft.com/en-us/defender-cloud-apps/anomaly-detection-policy)), these alerts are based on the learning period, and approximately 40 files were involved in the simulation. However, this number may vary depending on your organization's and tenant's environment.

![image](https://github.com/LearningKijo/ResearchDev/assets/120234772/a3431403-f1c4-4b58-b7fc-d7cf933a8051)

## Blue Note
Deploy Microsoft Entra ID and enable the following features:
- Multi-Factor Authentication (MFA)
- Conditional Access (Considering Sign-in/User Risk level, Compliance policy)
- Microsoft Entra ID Protection
- Smart lockout
- Password Protection

Deploy Microsoft Defender for Cloud Apps

Deploy Microsoft Defender XDR 

## Reference
- [Behind the scenes of business email compromise: Using cross-domain threat data to disrupt a large BEC campaign](https://www.microsoft.com/en-us/security/blog/2021/06/14/behind-the-scenes-of-business-email-compromise-using-cross-domain-threat-data-to-disrupt-a-large-bec-infrastructure/)
- [Detecting and mitigating a multi-stage AiTM phishing and BEC campaign](https://www.microsoft.com/en-us/security/blog/2023/06/08/detecting-and-mitigating-a-multi-stage-aitm-phishing-and-bec-campaign/)

#### Disclaimer
The views and opinions expressed herein are those of the author and do not necessarily reflect the views of company.
